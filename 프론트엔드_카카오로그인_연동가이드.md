# 카카오 로그인 연동 가이드

## 📌 서버 정보
- **Base URL**: `http://172.20.10.3:8080`
- **인증 방식**: JWT 토큰 기반 (Bearer Token)
- **CORS**: 모든 Origin 허용

---

## 🔐 카카오 로그인 플로우

### 1. 카카오 로그인 시작
앱에서 카카오 로그인 버튼을 클릭하면 아래 URL로 리다이렉트:

```
GET http://172.20.10.3:8080/oauth2/authorization/kakao
```

**주의사항:**
- 웹뷰나 인앱 브라우저에서 열어야 합니다
- 카카오 로그인 페이지로 자동 리다이렉트됩니다
- 사용자가 카카오 계정으로 로그인하면 서버로 자동 리다이렉트됩니다

### 2. 로그인 성공 응답
카카오 로그인 성공 시, 서버에서 **JSON 형식**으로 응답이 옵니다:

```json
{
  "success": true,
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "email": "user@example.com",
  "message": "로그인 성공"
}
```

**응답 필드:**
- `success`: 로그인 성공 여부 (boolean)
- `token`: JWT 토큰 (string) - **이 토큰을 저장해야 합니다!**
- `email`: 사용자 이메일 (string)
- `message`: 응답 메시지 (string)

### 3. 토큰 저장
받은 `token` 값을 **로컬 스토리지** 또는 **AsyncStorage**에 저장:

```javascript
// React Native 예시
import AsyncStorage from '@react-native-async-storage/async-storage';

// 토큰 저장
await AsyncStorage.setItem('authToken', response.token);
```

```javascript
// React/웹 예시
localStorage.setItem('authToken', response.token);
```

---

## 🔑 API 호출 방법

모든 인증이 필요한 API 호출 시, **Authorization 헤더**에 토큰을 포함해야 합니다.

### 헤더 형식
```
Authorization: Bearer {토큰값}
```

### 예시 코드

#### React Native (Axios)
```javascript
import axios from 'axios';
import AsyncStorage from '@react-native-async-storage/async-storage';

// Axios 인스턴스 생성
const api = axios.create({
  baseURL: 'http://172.20.10.3:8080',
});

// 요청 인터셉터: 모든 요청에 토큰 자동 추가
api.interceptors.request.use(async (config) => {
  const token = await AsyncStorage.getItem('authToken');
  if (token) {
    config.headers.Authorization = `Bearer ${token}`;
  }
  return config;
});

// 사용 예시
const getUserInfo = async () => {
  try {
    const response = await api.get('/api/user/me');
    console.log(response.data);
  } catch (error) {
    console.error('에러:', error.response?.data);
  }
};
```

#### React/웹 (Fetch)
```javascript
// 토큰 가져오기
const token = localStorage.getItem('authToken');

// API 호출
fetch('http://172.20.10.3:8080/api/user/me', {
  method: 'GET',
  headers: {
    'Authorization': `Bearer ${token}`,
    'Content-Type': 'application/json',
  },
})
  .then(response => response.json())
  .then(data => console.log(data))
  .catch(error => console.error('에러:', error));
```

---

## 📡 API 엔드포인트

### 1. 내 정보 조회
**인증 필요**

```
GET /api/user/me
```

**요청 헤더:**
```
Authorization: Bearer {토큰}
```

**응답 예시:**
```json
{
  "name": "사용자",
  "email": "user@example.com",
  "picture": null,
  "role": "GUEST"
}
```

---

### 2. 좋아요/싫어요 등록
**인증 필요**

```
POST /api/likes
```

**요청 헤더:**
```
Authorization: Bearer {토큰}
Content-Type: application/json
```

**요청 Body:**
```json
{
  "songId": 1,
  "like": true
}
```

**파라미터:**
- `songId`: 노래 ID (number, 필수)
- `like`: `true` = 좋아요, `false` = 싫어요 (boolean, 필수)

**응답 예시:**
```
"좋아요 완료"
"싫어요 완료"
"반응 취소됨"
"상태 변경됨 (좋아요)"
```

---

## ⚠️ 에러 처리

### 1. 인증 실패 (401)
토큰이 없거나 유효하지 않은 경우:

```json
{
  "error": "Unauthorized",
  "message": "로그인이 필요합니다."
}
```

**대응 방법:**
- 토큰이 저장되어 있는지 확인
- 토큰이 만료되었는지 확인 (토큰 만료 시간: 1시간)
- 필요시 다시 로그인 요청

### 2. 토큰 만료
토큰이 만료된 경우, 다시 로그인해야 합니다.

### 3. 네트워크 에러
서버에 연결할 수 없는 경우:
- 서버 주소 확인: `http://172.20.10.3:8080`
- 네트워크 연결 확인
- CORS 에러인 경우, 서버 측 CORS 설정 확인

---

## 🔄 전체 로그인 플로우 예시

### React Native 예시
```javascript
import React from 'react';
import { View, Button, Alert } from 'react-native';
import { WebView } from 'react-native-webview';
import AsyncStorage from '@react-native-async-storage/async-storage';
import axios from 'axios';

const LoginScreen = () => {
  const [webViewVisible, setWebViewVisible] = React.useState(false);
  const [webViewUrl, setWebViewUrl] = React.useState('');

  // 카카오 로그인 시작
  const handleKakaoLogin = () => {
    const loginUrl = 'http://172.20.10.3:8080/oauth2/authorization/kakao';
    setWebViewUrl(loginUrl);
    setWebViewVisible(true);
  };

  // 웹뷰에서 로그인 성공 시 호출
  const handleNavigationStateChange = async (navState) => {
    const { url } = navState;
    
    // 로그인 성공 응답 확인 (실제로는 서버에서 JSON 응답이 옴)
    if (url.includes('login-success') || url.includes('token')) {
      try {
        // 실제로는 서버에서 JSON 응답을 받아야 함
        // 여기서는 예시로 직접 API 호출
        const response = await axios.get('http://172.20.10.3:8080/api/user/me', {
          headers: {
            'Authorization': `Bearer ${await AsyncStorage.getItem('authToken')}`
          }
        });
        
        Alert.alert('로그인 성공', '환영합니다!');
        setWebViewVisible(false);
      } catch (error) {
        Alert.alert('에러', '로그인에 실패했습니다.');
      }
    }
  };

  return (
    <View>
      <Button title="카카오로 로그인" onPress={handleKakaoLogin} />
      
      {webViewVisible && (
        <WebView
          source={{ uri: webViewUrl }}
          onNavigationStateChange={handleNavigationStateChange}
          onMessage={(event) => {
            // 서버에서 JSON 응답을 받는 경우
            try {
              const data = JSON.parse(event.nativeEvent.data);
              if (data.token) {
                AsyncStorage.setItem('authToken', data.token);
                setWebViewVisible(false);
                Alert.alert('로그인 성공', '환영합니다!');
              }
            } catch (e) {
              console.error('파싱 에러:', e);
            }
          }}
        />
      )}
    </View>
  );
};

export default LoginScreen;
```

---

## 📝 중요 사항

1. **토큰 저장**: 로그인 성공 시 받은 토큰을 반드시 저장하세요
2. **토큰 만료**: 토큰은 1시간 후 만료됩니다. 만료 시 다시 로그인 필요
3. **HTTPS 권장**: 프로덕션 환경에서는 HTTPS 사용을 권장합니다
4. **에러 처리**: 모든 API 호출에 에러 처리를 구현하세요
5. **토큰 갱신**: 현재는 토큰 갱신 기능이 없으므로, 만료 시 재로그인이 필요합니다

---

## 🆘 문제 해결

### Q: 로그인 후 토큰을 받지 못해요
A: 서버 응답을 확인하고, JSON 파싱이 제대로 되는지 확인하세요. 웹뷰의 `onMessage` 이벤트를 활용하세요.

### Q: API 호출 시 401 에러가 나요
A: 
- 토큰이 헤더에 제대로 포함되었는지 확인
- 토큰이 만료되지 않았는지 확인
- `Authorization: Bearer {토큰}` 형식이 맞는지 확인

### Q: CORS 에러가 나요
A: 서버 측에서 CORS가 설정되어 있지만, 특정 Origin만 허용해야 하는 경우 백엔드 개발자에게 문의하세요.

---

## 📞 문의
문제가 발생하면 백엔드 개발자에게 문의하세요.

